name: Physics Server Rapier Build
description: Build Godot Cpp and the Physics Server 2D Extension.

inputs:
  platform:
    required: true
    description: Target platform.
  arch:
    required: true
    default: ''
    description: Rust target platform.
  extra_flags:
    required: false
    default: ''
    description: Rust extra flags.
  env_flags:
    required: false
    default: ''
    description: RUSTFLAGS env var.
  precision:
    required: true
    description: single or double
  features:
    required: true
    description: simd-nightly,simd-stable,parallel,enhanced-determinism

runs:
  using: composite
  steps:
    - name: Rust Install Nightly
      run: |
        rustup install nightly
        rustup default nightly
        #rustup toolchain install nightly
        #rustup override set nightly
        #rustup component add rust-src --toolchain nightly-x86_64-unknown-linux-gnu
    - name: Build Rapier
      shell: sh
      run: |
        rustup target add ${{ inputs.arch }}
        cargo build --target=${{ inputs.arch }} --release --features="${{ inputs.features }},${{ inputs.precision }}" ${{ inputs.extra_flags}}
        mkdir -p target/release
        rm -rf target/release
        cp -rf target/${{ inputs.rust_target }}/release target/release
      env:
        RUSTFLAGS: ${{ inputs.env_flags }}
    - name: Build Rapier Macos Universal
      shell: sh
      
      # we already built for x86_64-apple-darwin for mac, now build arm64
      if: ${{ inputs.platform == 'macos'}}
      run: |
        mkdir -p target/release
        rustup target add aarch64-apple-darwin
        cargo build --target=aarch64-apple-darwin --release --features="${{ inputs.features }},${{ inputs.precision }}"
        lipo -create -output target/release/librapier2d_wrapper.a target/aarch64-apple-darwin/release/librapier2d_wrapper.a target/x86_64-apple-darwin/release/librapier2d_wrapper.a
